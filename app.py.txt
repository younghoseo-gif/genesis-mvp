import streamlit as st
import google.generativeai as genai
import time
import urllib.parse
import random
import re

# ------------------------------------------------------------------
# 1. Page Config & Style
# ------------------------------------------------------------------
st.set_page_config(page_title="Genesis: Business Roast", page_icon="ğŸ”¥", layout="centered")

# [NEW] ê°œë°œì ëª¨ë“œ (ì‚¬ì´ë“œë°”)
with st.sidebar:
    st.header("ğŸ› ï¸ Admin Tools")
    dev_mode = st.checkbox("ğŸ”“ ë¸”ëŸ¬ í•´ì œ (X-Ray Mode)", value=False)

st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    html, body, [class*="css"] { font-family: 'Inter', sans-serif; background-color: #FFFFFF; color: #191F28; }
    .stButton>button { width: 100%; border-radius: 12px; height: 50px; font-weight: 800; font-size: 16px; border: none; transition: 0.3s; }
    .primary-btn>button { background-color: #F04452; color: white; }
    .score-card { text-align: center; padding: 20px; border-radius: 15px; background: #f8f9fa; margin-bottom: 20px; border: 2px solid #e9ecef; }
    
    /* ë¸”ëŸ¬ ì²˜ë¦¬ ìŠ¤íƒ€ì¼ */
    .blur-content { filter: blur(5px); user-select: none; opacity: 0.6; pointer-events: none; }
    /* ê°œë°œì ëª¨ë“œì¼ ë•Œ ë¸”ëŸ¬ ì œê±° */
    .no-blur { filter: none !important; opacity: 1 !important; pointer-events: auto !important; }
    
    .locked-box { position: relative; text-align: center; padding: 40px; background: #fff3cd; border: 2px dashed #ffc107; border-radius: 12px; margin-top: -100px; z-index: 10; }
    div[role="radiogroup"] { justify-content: center; }
    th, td { border-bottom: 1px solid #ddd; padding: 10px; }
    </style>
""", unsafe_allow_html=True)

# ------------------------------------------------------------------
# 2. API Connection
# ------------------------------------------------------------------
try:
    api_key = st.secrets["GOOGLE_API_KEY"]
    genai.configure(api_key=api_key)
except:
    st.error("ğŸš¨ API Key Error. Check .streamlit/secrets.toml")
    st.stop()

# ------------------------------------------------------------------
# 3. Data Decks
# ------------------------------------------------------------------
KR_IDEAS = [
    "í—¤ì–´ì§„ ì—°ì¸ì˜ ì‚¬ì§„ì—ì„œ ì–¼êµ´ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ì§€ì›Œì£¼ëŠ” AI ì§€ìš°ê°œ",
    "ì¸µê°„ì†ŒìŒì´ ë°œìƒí•˜ë©´ ìœ—ì§‘ì— ìë™ìœ¼ë¡œ ë³µìˆ˜ ìŒì•…ì„ íŠ¸ëŠ” ìŠ¤í”¼ì»¤",
    "ë…ì„œì‹¤ì—ì„œ ì¡¸ë©´ ì „ê¸° ì¶©ê²©ì„ ì£¼ëŠ” í•™ìŠµìš© ì›¨ì–´ëŸ¬ë¸” ë°´ë“œ",
    "ë‚´ê°€ ì‚° ì£¼ì‹ì´ ë–¨ì–´ì§€ë©´ ìš•í•´ì£¼ê³  ìœ„ë¡œí•´ì£¼ëŠ” AI ìƒë‹´ì‚¬",
    "ë§¤ì¼ ì•„ì¹¨ ë™ê¸°ë¶€ì—¬ ëª…ì–¸ ëŒ€ì‹  'ë„ˆ ê·¸ëŸ¬ë‹¤ ë§í•œë‹¤'ê³  ì•…ë‹´í•˜ëŠ” ì•ŒëŒ ì•±",
    "ì†Œê°œíŒ… ì‹¤íŒ¨ ì‹œ ì‹ë¹„ì˜ 50%ë¥¼ ë³´ìƒí•´ì£¼ëŠ” ë°ì´íŒ… ì•± ë³´í—˜",
    "ì“°ë ˆê¸° ë¶„ë¦¬ìˆ˜ê±°ë¥¼ ëŒ€ì‹  í•´ì£¼ëŠ” ë¡œë´‡ êµ¬ë… ì„œë¹„ìŠ¤",
    "í—¬ìŠ¤ì¥ ì•ˆ ê°€ëŠ” ë‚ ë§ˆë‹¤ ë²Œê¸ˆì„ ê±·ì–´ì„œ ê¸°ë¶€í•˜ëŠ” ìŠ¤ë§ˆíŠ¸ ì›Œì¹˜ ì•±",
    "ë‚´ ê¸°ë¶„ì— ë§ì¶°ì„œ ìë™ìœ¼ë¡œ ì¹µí…Œì¼ì„ ë§ì•„ì£¼ëŠ” í™ˆë°” ë¡œë´‡",
    "ì”ì†Œë¦¬í•˜ëŠ” ìƒì‚¬ì˜ ëª©ì†Œë¦¬ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¬µìŒ ì²˜ë¦¬í•´ì£¼ëŠ” ì´ì–´í°",
    "ìœ í†µê¸°í•œ ì„ë°•í•œ í¸ì˜ì  ë„ì‹œë½ì„ ë°˜ê°’ì— ì§€ë„ì— í‘œì‹œí•˜ëŠ” ì•±",
    "ìš°ë¦¬ ë™ë„¤ ë¶•ì–´ë¹µ íŠ¸ëŸ­ ìœ„ì¹˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ í•˜ëŠ” ëŒ€ë™ë¶•ì–´ì§€ë„",
    "ì½”ë”©ì„ ëª°ë¼ë„ ë§ë§Œ í•˜ë©´ ì•±ì„ ë§Œë“¤ì–´ì£¼ëŠ” ë…¸ì½”ë“œ íˆ´ Genesis",
    "íƒˆëª¨ ì§„í–‰ ìƒí™©ì„ AIë¡œ ë¶„ì„í•´ì„œ ê°€ë°œì„ ë¯¸ë¦¬ ë§ì¶°ì£¼ëŠ” ì„œë¹„ìŠ¤",
    "ê²°í˜¼ì‹ í•˜ê° ëŒ€í–‰ ì•Œë°”ë¥¼ ì„±í–¥ë³„(MBTI)ë¡œ ë§¤ì¹­í•˜ëŠ” í”Œë«í¼"
]

EN_IDEAS = [
    "AI-powered eraser that removes your ex-lover from photos naturally.",
    "Smart speaker that automatically plays revenge music when upstairs neighbors are noisy.",
    "Wearable band that gives electric shocks if you fall asleep in the library.",
    "AI therapist that roasts you when your stocks plummet.",
    "Alarm app that wakes you up with insults instead of motivational quotes.",
    "Dating app insurance that refunds 50% of meal costs if the date fails.",
    "Robot subscription service that handles recycling and trash sorting.",
    "Smartwatch app that donates your money to charity every time you skip the gym.",
    "Home bar robot that mixes cocktails automatically based on your mood.",
    "Noise-canceling earphones that mute your boss's nagging in real-time.",
    "Map app showing half-price convenience store food nearing expiration.",
    "Community map sharing real-time locations of street food trucks.",
    "No-code tool Genesis that builds apps just by listening to your voice.",
    "AI service that predicts hair loss and custom-fits wigs in advance.",
    "Platform matching fake wedding guests based on MBTI personalities."
]

if 'user_input' not in st.session_state:
    st.session_state.user_input = ""

# ------------------------------------------------------------------
# 4. Helper Functions
# ------------------------------------------------------------------
def pick_random_idea(lang):
    target_deck = KR_IDEAS if lang == 'ko' else EN_IDEAS
    st.session_state.user_input = random.choice(target_deck)

def get_ui_text(lang_code):
    text_pack = {
        "ko": {
            "main_title": "Genesis ğŸ”¥",
            "sub_title": "AIê°€ ë‹¹ì‹ ì˜ ì‚¬ì—… ì•„ì´ë””ì–´ë¥¼ íŒ©íŠ¸ë¡œ í­í–‰í•©ë‹ˆë‹¤.<br>ë©˜íƒˆ ì•½í•œ ë¶„ì€ ë’¤ë¡œ ê°€ì„¸ìš”.",
            "input_label": "ì‚¬ì—…/ìœ íŠœë¸Œ/ì›¹ì†Œì„¤ ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
            "input_placeholder": "ì˜ˆ: ì§ì¥ì¸ë“¤ì„ ìœ„í•œ ì ì‹¬ ë©”ë‰´ ì¶”ì²œ êµ¬ë… ì„œë¹„ìŠ¤",
            "analyze_btn": "ğŸ”¥ íŒ©íŠ¸ í­ë ¥ ë‹¹í•˜ê¸° (ë¶„ì„)",
            "random_btn": "ğŸ² ì˜ˆì‹œ ì•„ì´ë””ì–´ ë„£ê¸°",
            "warning": "ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•´ì•¼ íŒ° ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "connecting": "ğŸ§  Genesis Brain ì ‘ì† ì¤‘...",
            "analyzing": "ğŸ” ì•„ì´ë””ì–´ í•´ë¶€ ì¤‘...",
            "calculating": "ğŸ’° ìˆ˜ìµ ëª¨ë¸ ê³„ì‚° ì¤‘...",
            "score_title": "ìƒì¡´ í™•ë¥ ",
            "tab_free": "ğŸ”¥ íŒ©íŠ¸ í­ë ¥ (ë¬´ë£Œ)",
            "tab_paid": "ğŸ“Š ì‹¬ì¸µ ë¦¬í¬íŠ¸ (Premium)",
            "roast_title": "ğŸ’€ ì™œ ë§í•˜ëŠ”ê°€?",
            "share_btn": "ğŸ¦ íŠ¸ìœ„í„°ë¡œ ê³µìœ í•˜ê¸°",
            "share_msg": "ë‚´ ì‚¬ì—… ì•„ì´ë””ì–´ ì ìˆ˜: {score}ì  ã…‹ã…‹ã…‹\nAIê°€ '{one_liner}'ë¼ê³  í•¨.\në„ˆë„ ë‹¹í•´ë´ë¼ ğŸ‘‰",
            "info_msg": "ğŸ’¡ ì´ íƒ­ì€ ë‹¹ì‹ ì´ 'ì‚´ì•„ë‚¨ì„ ë°©ë²•'ì„ ì•Œë ¤ì¤ë‹ˆë‹¤.",
            "swot_title": "1. SWOT ë¶„ì„",
            "money_title": "2. ğŸ’° êµ¬ì²´ì  ìˆ˜ìµí™” ëª¨ë¸ (Top 3)",
            "survival_title": "3. ğŸ›¡ï¸ ìœ ì¼í•œ ìƒì¡´ ì „ëµ",
            "lock_title": "ğŸ”“ ë¦¬í¬íŠ¸ ì „ì²´ ì ê¸ˆ í•´ì œ",
            "lock_desc": "ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ ì‚´ë¦´ <b>êµ¬ì²´ì ì¸ ìƒì¡´ ì „ëµ</b>ê³¼ <b>ìˆ˜ìµ ëª¨ë¸</b>ì´ ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤.",
            "price": "ë‹¨ëˆ 4,900ì› (ì»¤í”¼ í•œ ì” ê°’)",
            "unlock_btn": "ğŸ‘‰ ì§€ê¸ˆ í•´ì œí•˜ê³  ìƒì¡´í•˜ê¸°",
            "prompt_lang_instruction": "Output must be in KOREAN."
        },
        "en": {
            "main_title": "Genesis ğŸ”¥",
            "sub_title": "AI roasts your business idea with brutal facts.<br>Weak hearts, please leave.",
            "input_label": "Enter your Startup / YouTube / Novel idea",
            "input_placeholder": "e.g., Subscription lunch service for office workers",
            "analyze_btn": "ğŸ”¥ Roast My Idea",
            "random_btn": "ğŸ² Random Idea",
            "warning": "Please enter an idea to get roasted.",
            "connecting": "ğŸ§  Connecting to Genesis Brain...",
            "analyzing": "ğŸ” Analyzing Idea...",
            "calculating": "ğŸ’° Calculating Revenue...",
            "score_title": "Success Rate",
            "tab_free": "ğŸ”¥ Roast (Free)",
            "tab_paid": "ğŸ“Š Deep Report (Premium)",
            "roast_title": "ğŸ’€ Brutal Feedback",
            "share_btn": "ğŸ¦ Share on X (Twitter)",
            "share_msg": "My Business Score: {score}/100 ğŸ’€\nAI said: '{one_liner}'\nTry here ğŸ‘‰",
            "info_msg": "ğŸ’¡ This tab reveals how to survive.",
            "swot_title": "1. SWOT Analysis",
            "money_title": "2. ğŸ’° Monetization Strategy",
            "survival_title": "3. ğŸ›¡ï¸ Survival Strategy",
            "lock_title": "ğŸ”“ Unlock Full Report",
            "lock_desc": "Get the <b>Survival Strategy</b> & <b>Revenue Model</b> to save this idea.",
            "price": "Only $4.90",
            "unlock_btn": "ğŸ‘‰ Unlock Now",
            "prompt_lang_instruction": "Output must be in ENGLISH."
        }
    }
    return text_pack[lang_code]

# ------------------------------------------------------------------
# 5. UI Layout
# ------------------------------------------------------------------
col_lang1, col_lang2, col_lang3 = st.columns([1, 2, 1])
with col_lang2:
    lang_choice = st.radio("ì–¸ì–´ ì„ íƒ / Select Language", ["ğŸ‡°ğŸ‡· í•œêµ­ì–´", "ğŸ‡ºğŸ‡¸ English"], horizontal=True, label_visibility="collapsed")

current_lang = "ko" if "í•œêµ­ì–´" in lang_choice else "en"
ui = get_ui_text(current_lang)

st.markdown(f'<div style="font-size: 36px; font-weight: 800; color: #191F28; margin-bottom: 5px; text-align: center;">{ui["main_title"]}</div>', unsafe_allow_html=True)
st.markdown(f'<div style="font-size: 16px; color: #8B95A1; margin-bottom: 30px; text-align: center;">{ui["sub_title"]}</div>', unsafe_allow_html=True)

user_text = st.text_area(ui["input_label"], height=120, placeholder=ui["input_placeholder"], key="user_input")

col1, col2 = st.columns([1, 1])
with col1:
    analyze_btn = st.button(ui["analyze_btn"], type="primary")
with col2:
    st.button(ui["random_btn"], on_click=pick_random_idea, args=(current_lang,))

# ------------------------------------------------------------------
# 6. Analysis Engine
# ------------------------------------------------------------------
if analyze_btn:
    if not user_text:
        st.warning(ui["warning"])
    else:
        status_box = st.status(ui["connecting"], expanded=True)
        progress_bar = status_box.progress(0)
        
        try:
            model_name = "gemini-2.5-flash"
            generation_config = {"temperature": 0.0, "max_output_tokens": 8192}
            
            model = genai.GenerativeModel(model_name, generation_config=generation_config)
            progress_bar.progress(30)
            status_box.write(ui["analyzing"])
            
            prompt = f"""
            You are Genesis, a cynical VC.
            [User Idea]: "{user_text}"
            
            [Task]: Analyze this idea.
            [CRITICAL RULE]: {ui['prompt_lang_instruction']}
            (Ignore the input language, follow the USER SELECTED language: {current_lang})
            
            [Content Rules]:
            - NO GENERIC ADVICE (e.g., "Hire a marketing team", "Make a good UI").
            - Focus on SPECIFIC RISKS (e.g., "Competitor X has 90% market share", "Legal regulation Y will kill this").
            - Be sharp, brutal, but logical.
            
            [Scoring Rules]:
            - Clear potential? High Score (75-95).
            - Vague/Bad? Low Score (0-50).
            - Tone: Cynical & Brutal.
            
            [Output Format]:
            Use these EXACT separators.
            
            [[[SCORE]]]
            (Number 0-100 only)
            
            [[[ONE_LINER]]]
            (Short witty punchline)
            
            [[[FEEDBACK]]]
            (3 paragraphs of brutal feedback)
            
            [[[SWOT]]]
            (MUST BE A MARKDOWN TABLE. No text paragraphs. Format: | Category | Description |)
            
            [[[MONETIZATION]]]
            (3 concrete ways)
            
            [[[SURVIVAL]]]
            (The ONLY way to survive)
            """
            
            response = model.generate_content(prompt)
            progress_bar.progress(80)
            status_box.write(ui["calculating"])
            
            content = response.text
            
            parsed_data = {
                "SCORE": "", "ONE_LINER": "", "FEEDBACK": "", 
                "SWOT": "", "MONETIZATION": "", "SURVIVAL": ""
            }
            
            current_section = None
            lines = content.split('\n')
            
            for line in lines:
                upper_line = line.upper()
                if "[[[SCORE" in upper_line: current_section = "SCORE"
                elif "[[[ONE_LINER" in upper_line: current_section = "ONE_LINER"
                elif "[[[FEEDBACK" in upper_line: current_section = "FEEDBACK"
                elif "[[[SWOT" in upper_line: current_section = "SWOT"
                elif "[[[MONETIZATION" in upper_line or "[[[MONEY" in upper_line: current_section = "MONETIZATION"
                elif "[[[SURVIVAL" in upper_line: current_section = "SURVIVAL"
                else:
                    if current_section:
                        parsed_data[current_section] += line + "\n"

            score_text = parsed_data["SCORE"].strip()
            score_match = re.findall(r'\d+', score_text)
            score = int(score_match[0]) if score_match else 0
            
            one_liner = parsed_data["ONE_LINER"].strip() or "Analyzing..."
            feedback = parsed_data["FEEDBACK"].strip() or "Feedback unavailable."
            swot = parsed_data["SWOT"].strip() or "SWOT unavailable."
            money = parsed_data["MONETIZATION"].strip() or "Monetization unavailable."
            survival = parsed_data["SURVIVAL"].strip() or "Survival plan unavailable."

            progress_bar.progress(100)
            status_box.update(label="Complete!", state="complete", expanded=False)
            
            # Result Display
            st.divider()
            
            st.markdown(f"""
            <div class="score-card">
                <h2 style='margin:0; color:#888;'>{ui['score_title']}</h2>
                <h1 style='font-size:60px; margin:0; color:{"#F04452" if score < 70 else "#00C853"};'>{score}%</h1>
                <p style='font-size:18px; font-weight:bold;'>"{one_liner}"</p>
            </div>
            """, unsafe_allow_html=True)
            
            tab1, tab2 = st.tabs([ui['tab_free'], ui['tab_paid']])
            
            with tab1:
                st.subheader(ui['roast_title'])
                st.write(feedback)
                st.markdown("---")
                
                final_share_text = urllib.parse.quote(ui['share_msg'].format(score=score, one_liner=one_liner))
                
                st.markdown(f"""
                <a href="https://twitter.com/intent/tweet?text={final_share_text}&url=https://genesis-mvp.streamlit.app" target="_blank">
                    <button style='background:#1DA1F2; color:white; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer;'>
                        {ui['share_btn']}
                    </button>
                </a>
                """, unsafe_allow_html=True)

            with tab2:
                # [NEW] ê°œë°œì ëª¨ë“œ ì²´í¬ ì—¬ë¶€ì— ë”°ë¼ ë¸”ëŸ¬ í´ë˜ìŠ¤ ê²°ì •
                blur_class = "blur-content" if not dev_mode else "no-blur"
                
                st.info(ui['info_msg'])
                st.markdown(f"### {ui['swot_title']}")
                st.markdown(swot)
                st.markdown("---")
                
                st.markdown(f"### {ui['money_title']}")
                # ë¸”ëŸ¬ ì²˜ë¦¬ëœ ë¶€ë¶„ì— blur_class ì ìš©
                st.markdown(f'<div class="{blur_class}">{money}</div>', unsafe_allow_html=True)
                
                st.markdown(f"### {ui['survival_title']}")
                # ë¸”ëŸ¬ ì²˜ë¦¬ëœ ë¶€ë¶„ì— blur_class ì ìš©
                st.markdown(f'<div class="{blur_class}">{survival}</div>', unsafe_allow_html=True)
                
                # ì ê¸ˆ ìƒì (ê°œë°œì ëª¨ë“œì¼ ë•ŒëŠ” ìˆ¨ê¸°ê³  ì‹¶ë‹¤ë©´ if not dev_mode: ë¡œ ê°ì‹¸ë©´ ë¨. 
                # ì¼ë‹¨ì€ ë¸”ëŸ¬ê°€ í’€ë ¤ë„ 'ê²°ì œ ìœ ë„ ë°•ìŠ¤'ê°€ ìœ„ì— ë–  ìˆëŠ” êµ¬ì¡°ì´ë¯€ë¡œ, 
                # X-rayì²˜ëŸ¼ ë’¤ê°€ ë¹„ì³ ë³´ì´ëŠ”ì§€ í™•ì¸í•˜ì‹œë©´ ë©ë‹ˆë‹¤.)
                st.markdown(f"""
                <div class="locked-box">
                    <h2>{ui['lock_title']}</h2>
                    <p>{ui['lock_desc']}</p>
                    <p style='color:#F04452; font-weight:bold;'>{ui['price']}</p>
                    <a href="https://toss.me/YOUR_ID" target="_blank">
                        <button style='background:#28a745; color:white; border:none; padding:15px 30px; border-radius:10px; font-size:18px; font-weight:bold; cursor:pointer; width:100%;'>
                            {ui['unlock_btn']}
                        </button>
                    </a>
                </div>
                """, unsafe_allow_html=True)

        except Exception as e:
            st.error(f"Error: {e}")